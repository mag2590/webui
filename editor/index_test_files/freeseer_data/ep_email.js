function initPopupForm(){var a=$("#ep_email_form_popup").is(":visible");if(!a){var b=pad.getPadId()+"email";cookie.getPref(b)!=="true"&&askClientToEnterEmail()}}function clientHasAlreadyRegistered(){var a=pad.getUserId(),b={};b.type="USERINFO_AUTHOR_EMAIL_IS_REGISTERED_TO_PAD",b.userInfo={},b.userInfo.userId=a,pad.collabClient.sendMessage(b)}function askClientToEnterEmail(){var a=$(".ep_email_settings").html().replace("ep_email_form_mysettings","ep_email_form_popup");$.gritter.add({title:window._("ep_email_notifications.titleGritterSubscr"),text:"<p class='ep_email_form_popup_header'>"+window._("ep_email_notifications.headerGritterSubscr")+"</p>"+a,sticky:!0,time:2e3,after_open:function(a){$("#ep_email_form_popup").submit(function(){return sendEmailToServer("ep_email_form_popup"),!1}),$("#ep_email_form_popup [name=ep_email_subscribe]").on("click",function(a){$("#ep_email_form_popup [name=ep_email_option]").val("subscribe"),checkAndSend(a)}),$("#ep_email_form_popup [name=ep_email_unsubscribe]").on("click",function(a){$("#ep_email_form_popup [name=ep_email_option]").val("unsubscribe"),checkAndSend(a)}),getDataForUserId("ep_email_form_popup"),optionsAlreadyRecovered=!0}})}function checkAndSend(a){var b=$(a.currentTarget.parentNode).attr("id"),c=$("#"+b+" [name=ep_email]").val();return c&&$("#"+b+" [name=ep_email_option]").val()=="subscribe"&&!$("#"+b+" [name=ep_email_onStart]").is(":checked")&&!$("#"+b+" [name=ep_email_onEnd]").is(":checked")?$.gritter.add({title:window._("ep_email_notifications.titleGritterError"),text:window._("ep_email_notifications.msgOptionsNotChecked")}):c&&$("#"+b).submit(),!1}function sendEmailToServer(a){var b=$("#"+a+" [name=ep_email]").val(),c=pad.getUserId(),d={};d.type="USERINFO_UPDATE",d.userInfo={},d.padId=pad.getPadId(),d.userInfo.email=b,d.userInfo.email_option=$("#"+a+" [name=ep_email_option]").val(),d.userInfo.email_onStart=$("#"+a+" [name=ep_email_onStart]").is(":checked"),d.userInfo.email_onEnd=$("#"+a+" [name=ep_email_onEnd]").is(":checked"),d.userInfo.formName=a,d.userInfo.userId=c,b&&pad.collabClient.sendMessage(d)}function getDataForUserId(a){var b=pad.getUserId(),c={};c.type="USERINFO_GET",c.padId=pad.getPadId(),c.userInfo={},c.userInfo.userId=b,c.userInfo.formName=a,pad.collabClient.sendMessage(c)}function showRegistrationSuccess(){$.gritter.add({title:window._("ep_email_notifications.titleGritterSubscr"),text:window._("ep_email_notifications.msgSubscrSuccess"),time:1e4})}function showAlreadyRegistered(a){if(a=="malformedEmail")var b=window._("ep_email_notifications.msgEmailMalformed");else if(a=="alreadyRegistered")var b=window._("ep_email_notifications.msgAlreadySubscr");else var b=window._("ep_email_notifications.msgUnknownErr");$.gritter.add({title:window._("ep_email_notifications.titleGritterSubscr"),text:b,time:7e3})}function showUnregistrationSuccess(){$.gritter.add({title:window._("ep_email_notifications.titleGritterUnsubscr"),text:window._("ep_email_notifications.msgUnsubscrSuccess"),time:1e4})}function showWasNotRegistered(){$.gritter.add({title:window._("ep_email_notifications.titleGritterUnsubscr"),text:window._("ep_email_notifications.msgUnsubscrNotExisting"),time:7e3})}var cookie=require("ep_etherpad-lite/static/js/pad_cookie").padcookie,optionsAlreadyRecovered=!1;if(typeof exports=="undefined")var exports=this.mymodule={};exports.postAceInit=function(a,b){typeof clientVars.panelDisplayLocation!="object"&&(clientVars.panelDisplayLocation={mysettings:!0,popup:!0}),clientVars.panelDisplayLocation.mysettings==1?($("#options-emailNotifications").prop("checked",!1),$("#options-emailNotifications").on("click",function(){optionsAlreadyRecovered?$(".ep_email_settings").slideToggle():(getDataForUserId("ep_email_form_mysettings"),optionsAlreadyRecovered=!0)}),$("[name=ep_email_subscribe]").on("click",function(a){$("[name=ep_email_option]").val("subscribe"),checkAndSend(a)}),$("[name=ep_email_unsubscribe]").on("click",function(a){$("[name=ep_email_option]").val("unsubscribe"),checkAndSend(a)}),$("#ep_email_form_mysettings").submit(function(){return sendEmailToServer("ep_email_form_mysettings"),!1})):$("#options-emailNotifications").parent().hide(),clientVars.panelDisplayLocation.popup==1&&setTimeout(function(){initPopupForm()},1e4)},exports.handleClientMessage_emailSubscriptionSuccess=function(a,b){b.payload.success==0?(showAlreadyRegistered(b.payload.type),$("#"+b.payload.formName+" [name=ep_email]").select()):(showRegistrationSuccess(),cookie.setPref(pad.getPadId()+"email","true"),clientVars.panelDisplayLocation.mysettings==1&&$(".ep_email_settings").is(":visible")&&($(".ep_email_settings").slideToggle(),$("#options-emailNotifications").prop("checked",!1)),clientVars.panelDisplayLocation.popup==1&&$("#ep_email_form_popup").is(":visible")&&$("#ep_email_form_popup").parent().parent().parent().hide())},exports.handleClientMessage_emailUnsubscriptionSuccess=function(a,b){b.payload.success==0?(showWasNotRegistered(),$("#"+b.payload.formName+" [name=ep_email]").select()):(showUnregistrationSuccess(),cookie.setPref(pad.getPadId()+"email","false"),clientVars.panelDisplayLocation.mysettings==1&&$(".ep_email_settings").is(":visible")&&($(".ep_email_settings").slideToggle(),$("#options-emailNotifications").prop("checked",!1)),clientVars.panelDisplayLocation.popup==1&&$("#ep_email_form_popup").is(":visible")&&$("#ep_email_form_popup").parent().parent().parent().hide())},exports.handleClientMessage_emailNotificationGetUserInfo=function(a,b){var c=b.payload;c.success==1?($("[name=ep_email]").val(c.email),$("[name=ep_email_onStart]").prop("checked",c.onStart),$("[name=ep_email_onEnd]").prop("checked",c.onEnd)):($("[name=ep_email_onStart]").prop("checked",!0),$("[name=ep_email_onEnd]").prop("checked",!1)),c.formName=="ep_email_form_mysettings"&&$(".ep_email_settings").slideToggle()},exports.handleClientMessage_emailNotificationMissingParams=function(a,b){b.payload==1&&($.gritter.add({title:window._("ep_email_notifications.titleGritterError"),text:window._("ep_email_notifications.msgParamsMissing"),sticky:!0}),clientVars.panelDisplayLocation.mysettings==1&&$(".ep_email_settings").is(":visible")&&($(".ep_email_settings").slideToggle(),$("#options-emailNotifications").prop("checked",!1),$("#options-emailNotifications").parent().hide()),clientVars.panelDisplayLocation.popup==1&&$("#ep_email_form_popup").is(":visible")&&$("#ep_email_form_popup").parent().parent().parent().hide())}